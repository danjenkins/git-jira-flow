#!/bin/sh

function usage() {
    echo "usage: git issue finish <ISSUE_KEY>"
}

function cmd_finish() {
    login_jira

    local branch
    if [ -n "$1" ]; then
        branch=$(git_issue_branch "$1")
        test -n "$branch" || fail "Issue '$1' is not currently being worked on"
    else
        branch=$(git_current_branch)
    fi

    local issue_key=${branch%/*}
    check_jira_key "$issue_key"
    summary=$(get_jira_summary $issue_key)

    puts_step "Finishing branch: $branch"
    git checkout development
    git pull origin development 2>/dev/null
    git merge --no-ff "$branch" -m "Close $issue_key #resolved #fixed"
    git branch -d "$branch"
    git push origin development 2>/dev/null

    puts_step "Updating issue: $issue_key"
    jira_cmd -a progressIssue --issue "$issue_key" --step "Resolved"
}

function cmd_help() {
    usage
    exit 0
}
